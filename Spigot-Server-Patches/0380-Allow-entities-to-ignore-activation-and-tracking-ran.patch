From b9a61f87436fe2dcb5899a24bf272b32f9859ca2 Mon Sep 17 00:00:00 2001
From: connorhartley <vectrixu+gh@gmail.com>
Date: Fri, 5 Apr 2019 15:17:00 +1300
Subject: [PATCH] Allow entities to ignore activation and tracking range


diff --git a/src/main/java/net/minecraft/server/Entity.java b/src/main/java/net/minecraft/server/Entity.java
index 1aa910f40..8134895c2 100644
--- a/src/main/java/net/minecraft/server/Entity.java
+++ b/src/main/java/net/minecraft/server/Entity.java
@@ -189,6 +189,7 @@ public abstract class Entity implements ICommandListener, KeyedObject { // Paper
     public boolean spawnedViaMobSpawner; // Paper - Yes this name is similar to above, upstream took the better one
     protected int numCollisions = 0; // Paper
     public boolean noSave = false; // Paper
+    public boolean ignoreVisibilityRange = false; // Paper
     public void inactiveTick() { }
     // Spigot end
 
diff --git a/src/main/java/net/minecraft/server/EntityTrackerEntry.java b/src/main/java/net/minecraft/server/EntityTrackerEntry.java
index efc4c79ab..fd77fa8f7 100644
--- a/src/main/java/net/minecraft/server/EntityTrackerEntry.java
+++ b/src/main/java/net/minecraft/server/EntityTrackerEntry.java
@@ -504,7 +504,9 @@ public class EntityTrackerEntry {
         double d1 = entityplayer.locZ - (double) this.zLoc / 4096.0D;
         int i = Math.min(this.e, this.f);
 
-        return d0 >= (double) (-i) && d0 <= (double) i && d1 >= (double) (-i) && d1 <= (double) i && this.tracker.a(entityplayer);
+        // Paper start - Allow entities to ignore activation and tracking range
+        return (d0 >= (double) (-i) && d0 <= (double) i && d1 >= (double) (-i) && d1 <= (double) i && this.tracker.a(entityplayer)) || this.tracker.ignoreVisibilityRange;
+        // Paper stop
     }
 
     private boolean e(EntityPlayer entityplayer) {
diff --git a/src/main/java/net/minecraft/server/World.java b/src/main/java/net/minecraft/server/World.java
index bc231c7f2..1169c8eca 100644
--- a/src/main/java/net/minecraft/server/World.java
+++ b/src/main/java/net/minecraft/server/World.java
@@ -1117,6 +1117,7 @@ public abstract class World implements IBlockAccess {
 
     public boolean addEntity(Entity entity, SpawnReason spawnReason) { // Changed signature, added SpawnReason
         org.spigotmc.AsyncCatcher.catchOp( "entity add"); // Spigot
+        System.out.println("addEntity World");
         if (entity == null) return false;
         if (entity.valid) { MinecraftServer.LOGGER.error("Attempted Double World add on " + entity, new Throwable()); return true; } // Paper
 
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java
index a695a16ff..461129e7c 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java
@@ -819,4 +819,16 @@ public abstract class CraftEntity implements org.bukkit.entity.Entity {
         getHandle().noSave = noSave;
     }
     // Paper end
+
+    // Paper start
+    @Override
+    public void setIgnoreVisibilityRange(boolean ignore) {
+        getHandle().ignoreVisibilityRange = ignore;
+    }
+
+    @Override
+    public boolean ignoreVisibilityRange() {
+        return getHandle().ignoreVisibilityRange;
+    }
+    // Paper end
 }
diff --git a/src/main/java/org/spigotmc/ActivationRange.java b/src/main/java/org/spigotmc/ActivationRange.java
index 4c8d94c87..a56c4fbc3 100644
--- a/src/main/java/org/spigotmc/ActivationRange.java
+++ b/src/main/java/org/spigotmc/ActivationRange.java
@@ -208,6 +208,12 @@ public class ActivationRange
      */
     public static boolean checkEntityImmunities(Entity entity)
     {
+        // Paper start - Allow entities to ignore activation and tracking range
+        if (entity.ignoreVisibilityRange) {
+            return true;
+        }
+        // Paper end
+
         // Paper start - optimize Water cases
         if ((entity.inWater && (!(entity instanceof EntityInsentient) || !(((EntityInsentient) entity).getNavigation() instanceof NavigationGuardian)))) {
             return true;
-- 
2.15.1.windows.2

